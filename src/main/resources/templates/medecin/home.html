<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard MÃ©decin</title>
    <style>
        /* ======= Styles globaux ======= */
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#e8f4f8; min-height:100vh; padding:20px; }
        .container { max-width:1400px; margin:0 auto; }

        /* ======= Header ======= */
        .header { background:white; padding:30px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.08); margin-bottom:25px; border-left:5px solid #1a4d7a; }
        .header-content { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:20px; }
        .header-info h1 { color:#1a4d7a; font-size:28px; margin-bottom:8px; }
        .header-info p { color:#5a6c7d; font-size:15px; }
        .header-actions { display:flex; gap:12px; flex-wrap:wrap; }

        /* ======= Boutons ======= */
        .btn { padding:12px 24px; border-radius:8px; font-weight:600; font-size:14px; display:inline-flex; align-items:center; gap:8px; cursor:pointer; border:none; transition:all 0.3s; text-decoration:none; color:white; }
        .btn-primary { background:#1a4d7a; }
        .btn-primary:hover { background:#143d61; transform:translateY(-2px); }
        .btn-success { background:#00a86b; }
        .btn-success:hover { background:#008c59; transform:translateY(-2px); }
        .btn-danger { background:#e74c3c; }
        .btn-danger:hover { background:#c0392b; transform:translateY(-2px); }
        .btn-warning { background:#f39c12; color:#fff; }
        .btn-warning:hover { background:#d68910; transform:translateY(-2px); }
        .btn-sm { padding:8px 16px; font-size:13px; }

        /* ======= Stats ======= */
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px, 1fr)); gap:20px; margin-bottom:25px; }
        .stat-card { background:white; padding:25px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.08); text-align:center; border-top:4px solid #1a4d7a; transition:all 0.3s; }
        .stat-card:hover { transform:translateY(-3px); box-shadow:0 4px 15px rgba(0,0,0,0.12); }
        .stat-number { font-size:36px; font-weight:bold; color:#1a4d7a; margin-bottom:8px; }
        .stat-label { color:#5a6c7d; font-size:14px; font-weight:600; }

        /* ======= Sections ======= */
        .section { background:white; padding:30px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.08); margin-bottom:25px; }
        .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-bottom:15px; border-bottom:2px solid #e8f4f8; }
        .section-title { font-size:22px; color:#1a4d7a; font-weight:600; display:flex; align-items:center; gap:10px; }
        .badge { background:#e74c3c; color:white; padding:4px 12px; border-radius:12px; font-size:13px; font-weight:bold; margin-left:10px; }

        /* ======= RDV Grid ======= */
        .rdv-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(350px, 1fr)); gap:20px; }
        .rdv-card { background:#f8fcfd; border-radius:10px; padding:20px; border-left:4px solid #1a4d7a; transition:all 0.3s; }
        .rdv-card:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.1); }
        .rdv-card.attente { border-left-color:#f39c12; background:#fffbf5; }
        .rdv-card.accepte { border-left-color:#00a86b; background:#f0fdf8; }
        .rdv-card.refuse { border-left-color:#e74c3c; background:#fef5f5; }

        .rdv-patient { font-size:18px; font-weight:bold; color:#1a4d7a; margin-bottom:15px; }
        .rdv-info { display:flex; flex-direction:column; gap:8px; margin-bottom:15px; }
        .rdv-detail { display:flex; align-items:center; gap:8px; color:#5a6c7d; font-size:14px; }
        .rdv-motif { background:white; padding:12px; border-radius:6px; margin-bottom:15px; font-size:14px; color:#2c3e50; }
        .rdv-motif strong { color:#1a4d7a; }

        /* ======= Documents ======= */
        .documents-section { background:white; border-radius:8px; padding:15px; margin-bottom:15px; border:1px solid #e8f4f8; }
        .documents-title { font-weight:600; color:#1a4d7a; margin-bottom:12px; font-size:14px; }
        .document-item { display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f8fcfd; border-radius:6px; margin-bottom:8px; }
        .document-item:last-child { margin-bottom:0; }
        .document-name { font-size:13px; color:#2c3e50; flex:1; }
        .document-actions { display:flex; gap:8px; }

        .rdv-actions { display:flex; gap:10px; flex-wrap:wrap; }

        /* ======= Search ======= */
        .search-box { background:#f8fcfd; padding:20px; border-radius:10px; margin-bottom:25px; border:1px solid #e8f4f8; }
        .search-form { display:flex; gap:12px; flex-wrap:wrap; }
        .search-form input { flex:1; min-width:250px; padding:12px 20px; border:2px solid #d0e8f2; border-radius:8px; font-size:14px; transition:all 0.3s; }
        .search-form input:focus { outline:none; border-color:#1a4d7a; box-shadow:0 0 0 3px rgba(26,77,122,0.1); }

        /* ======= Table ======= */
        .patients-table { width:100%; border-collapse:collapse; margin-top:15px; }
        .patients-table th { background:#1a4d7a; color:white; padding:15px; text-align:left; font-weight:600; font-size:14px; }
        .patients-table th:first-child { border-radius:8px 0 0 0; }
        .patients-table th:last-child { border-radius:0 8px 0 0; }
        .patients-table td { padding:15px; border-bottom:1px solid #e8f4f8; font-size:14px; color:#2c3e50; }
        .patients-table tr:hover { background:#f8fcfd; }
        .patients-table tr:last-child td { border-bottom:none; }

        /* ======= Empty State ======= */
        .empty-state { text-align:center; padding:60px 20px; color:#95a5a6; }
        .empty-state-icon { font-size:64px; margin-bottom:15px; opacity:0.5; }
        .empty-state p { font-size:16px; font-weight:500; }
    </style>
</head>
<body>
<div class="container">
    <!-- HEADER -->
    <div class="header">
        <div class="header-content">
            <div class="header-info">
                <h1>ğŸ‘¨â€âš•ï¸ Dr. <span th:text="${medecin.prenom} + ' ' + ${medecin.nom}"></span></h1>
                <p>ğŸ“§ <span th:text="${medecin.email}"></span></p>
            </div>
            <div class="header-actions">
                <a th:href="@{/medecin/ajouterRdv}" class="btn btn-primary">ğŸ“… Nouveau RDV</a>
                <button type="button" class="btn btn-success" onclick="document.getElementById('modalAjoutPatient').style.display='flex'">â• Nouveau Patient</button>
                <a th:href="@{/logout}" class="btn btn-danger">ğŸšª DÃ©connexion</a>
            </div>
        </div>
    </div>

    <!-- STATISTIQUES -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number" th:text="${rdvEnAttente != null ? rdvEnAttente.size() : 0}">0</div>
            <div class="stat-label">â³ RDV en attente</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${rdvList != null ? rdvList.size() : 0}">0</div>
            <div class="stat-label">ğŸ“… RDV aujourd'hui</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${mesRdv != null ? mesRdv.size() : 0}">0</div>
            <div class="stat-label">ğŸ“Š Total RDV</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" th:text="${patientsList != null ? patientsList.size() : 0}">0</div>
            <div class="stat-label">ğŸ‘¥ Patients</div>
        </div>
    </div>

    //rdv en attetnte
    <div class="section" th:if="${rdvEnAttente != null and !rdvEnAttente.isEmpty()}">
        <div class="section-header">
            <div class="section-title">
                â³ Demandes de RDV en attente
                <span class="badge" th:text="${rdvEnAttente.size()}">0</span>
            </div>
        </div>

        <div class="rdv-grid">
            <div class="rdv-card attente" th:each="rdv : ${rdvEnAttente}">
                <div class="rdv-patient">
                    ğŸ‘¤ <span th:text="${rdv.patient.prenom} + ' ' + ${rdv.patient.nom}"></span>
                </div>

                <div class="rdv-info">
                    <div class="rdv-detail">
                        <span>ğŸ“…</span>
                        <span th:text="${#temporals.format(rdv.dateRdv, 'dd/MM/yyyy')}"></span>
                    </div>
                    <div class="rdv-detail">
                        <span>ğŸ•</span>
                        <span th:text="${rdv.heureRdv}"></span>
                    </div>
                    <div class="rdv-detail">
                        <span>ğŸ“§</span>
                        <span th:text="${rdv.patient.email}"></span>
                    </div>
                </div>

                <div class="rdv-motif">
                    <strong>ğŸ“‹ Motif :</strong> <span th:text="${rdv.motif}"></span>
                </div>

                <!-- Documents -->
                <div class="documents-section" th:if="${documentsParPatient != null and documentsParPatient.get(rdv.patient.id) != null and !documentsParPatient.get(rdv.patient.id).isEmpty()}">
                    <div class="documents-title">ğŸ“ Documents joints</div>
                    <div th:each="doc : ${documentsParPatient.get(rdv.patient.id)}">
                        <div class="document-item">
                            <span class="document-name" th:text="${doc.fileName}"></span>
                            <div class="document-actions">
                                <a th:href="@{/medecin/voir-document/{id}(id=${doc.id})}"
                                   class="btn btn-warning btn-sm" target="_blank">ğŸ‘ï¸</a>
                                <a th:href="@{/medecin/telecharger-document/{id}(id=${doc.id})}"
                                   class="btn btn-primary btn-sm">â¬‡ï¸</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="rdv-actions">
                    <form th:action="@{/medecin/accepter-rdv/{id}(id=${rdv.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn btn-success btn-sm">âœ… Accepter</button>
                    </form>
                    <form th:action="@{/medecin/refuser-rdv/{id}(id=${rdv.id})}" method="post" style="display: inline;"
                          onsubmit="return confirm('Refuser ce rendez-vous ?');">
                        <button type="submit" class="btn btn-danger btn-sm">âŒ Refuser</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== RDV DU JOUR ========== -->
    <div class="section">
        <div class="section-header">
            <div class="section-title">ğŸ“… Rendez-vous du jour</div>
        </div>

        <div class="rdv-grid" th:if="${rdvList != null and !rdvList.isEmpty()}">
            <div class="rdv-card"
                 th:each="rdv : ${rdvList}"
                 th:classappend="${rdv.status.toString() == 'EN_ATTENTE'} ? 'attente' :
                                (${rdv.status.toString() == 'ACCEPTE'} ? 'accepte' : 'refuse')">
                <div class="rdv-patient">
                    ğŸ‘¤ <span th:text="${rdv.patient.prenom} + ' ' + ${rdv.patient.nom}"></span>
                </div>

                <div class="rdv-info">
                    <div class="rdv-detail">
                        <span>ğŸ“…</span>
                        <span th:text="${#temporals.format(rdv.dateRdv, 'dd/MM/yyyy')}"></span>
                    </div>
                    <div class="rdv-detail">
                        <span>ğŸ•</span>
                        <span th:text="${rdv.heureRdv}"></span>
                    </div>
                    <div class="rdv-detail">
                        <span>ğŸ“§</span>
                        <span th:text="${rdv.patient.email}"></span>
                    </div>
                </div>

                <div class="rdv-motif">
                    <strong>ğŸ“‹ Motif :</strong> <span th:text="${rdv.motif}"></span>
                </div>

                <!-- Documents -->
                <div class="documents-section" th:if="${documentsParPatient != null and documentsParPatient.get(rdv.patient.id) != null and !documentsParPatient.get(rdv.patient.id).isEmpty()}">
                    <div class="documents-title">ğŸ“ Documents du patient</div>
                    <div th:each="doc : ${documentsParPatient.get(rdv.patient.id)}">
                        <div class="document-item">
                            <span class="document-name" th:text="${doc.fileName}"></span>
                            <div class="document-actions">
                                <a th:href="@{/medecin/voir-document/{id}(id=${doc.id})}"
                                   class="btn btn-warning btn-sm" target="_blank">ğŸ‘ï¸</a>
                                <a th:href="@{/medecin/telecharger-document/{id}(id=${doc.id})}"
                                   class="btn btn-primary btn-sm">â¬‡ï¸</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="rdv-actions">
                    <a th:href="@{/medecin/rdv/edit/{id}(id=${rdv.id})}" class="btn btn-warning btn-sm">âœï¸ Modifier</a>
                    <form th:action="@{/medecin/rdv/supprimer/{id}(id=${rdv.id})}" method="post" style="display: inline;"
                          onsubmit="return confirm('Supprimer ce rendez-vous ?');">
                        <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Supprimer</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="empty-state" th:if="${rdvList == null or rdvList.isEmpty()}">
            <div class="empty-state-icon">ğŸ“­</div>
            <p>Aucun rendez-vous aujourd'hui</p>
        </div>
    </div>


    <div class="section">
        <div class="section-header">
            <div class="section-title">ğŸ‘¥ Mes Patients</div>
        </div>


        <div class="search-box">
            <form id="searchForm" class="search-form" onsubmit="return false;">
                <input type="text" id="searchInput" placeholder="ğŸ” Rechercher un patient (nom, prÃ©nom, email)...">
                <button type="button" class="btn btn-primary">Rechercher</button>
                <a th:href="@{/medecin/home}" class="btn" style="background:#95a5a6;">RÃ©initialiser</a>
            </form>
        </div>

        <table class="patients-table" th:if="${patientsList != null and !patientsList.isEmpty()}">
            <thead>
            <tr>
                <th>Nom</th>
                <th>PrÃ©nom</th>
                <th>Email</th>
                <th style="text-align:center;">Actions</th>
            </tr>
            </thead>
            <tbody id="patientsBody">
            <tr th:each="patient : ${patientsList}">
                <td th:text="${patient.nom}"></td>
                <td th:text="${patient.prenom}"></td>
                <td th:text="${patient.email}"></td>
                <td style="text-align:center;">
                    <a th:href="@{/medecin/patient/edit/{id}(id=${patient.id})}" class="btn btn-warning btn-sm">âœï¸ Modifier</a>
                    <form th:action="@{/medecin/patient/supprimer/{id}(id=${patient.id})}" method="post" style="display:inline;" onsubmit="return confirm('Supprimer ce patient ?');">
                        <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Supprimer</button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="empty-state" id="emptyState" style="display:none;">
            <div class="empty-state-icon">ğŸ‘¥</div>
            <p>Aucun patient trouvÃ©</p>
        </div>
    </div>
</div>

<!-- MODAL AJOUT PATIENT -->
<div id="modalAjoutPatient" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:white; padding:40px; border-radius:12px; max-width:500px; width:90%; box-shadow:0 10px 40px rgba(0,0,0,0.2);">
        <h2 style="color:#1a4d7a; margin-bottom:25px; font-size:24px;">â• Nouveau Patient</h2>
        <form th:action="@{/medecin/save}" method="post">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#2c3e50; font-weight:600;">Nom</label>
                <input type="text" name="nom" required style="width:100%; padding:12px; border:2px solid #d0e8f2; border-radius:8px; font-size:14px;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#2c3e50; font-weight:600;">PrÃ©nom</label>
                <input type="text" name="prenom" required style="width:100%; padding:12px; border:2px solid #d0e8f2; border-radius:8px; font-size:14px;">
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:#2c3e50; font-weight:600;">Email</label>
                <input type="email" name="email" required style="width:100%; padding:12px; border:2px solid #d0e8f2; border-radius:8px; font-size:14px;">
            </div>
            <div style="margin-bottom:25px;">
                <label style="display:block; margin-bottom:8px; color:#2c3e50; font-weight:600;">Mot de passe</label>
                <input type="password" name="motDePasse" required style="width:100%; padding:12px; border:2px solid #d0e8f2; border-radius:8px; font-size:14px;">
            </div>
            <div style="display:flex; gap:12px; justify-content:flex-end;">
                <button type="button" class="btn" style="background:#95a5a6;" onclick="document.getElementById('modalAjoutPatient').style.display='none'">Annuler</button>
                <button type="submit" class="btn btn-success">âœ… Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<script>
    const searchInput = document.getElementById("searchInput");
    const patientsBody = document.getElementById("patientsBody");
    const emptyState = document.getElementById("emptyState");

    searchInput.addEventListener("input", function () {
        let motCle = this.value.trim();

        fetch("/medecin/patients/rechercher?motCle=" + encodeURIComponent(motCle))
            .then(res => res.json())
            .then(data => {
                patientsBody.innerHTML = "";

                if(data.length === 0){
                    emptyState.style.display = "block";
                    return;
                } else {
                    emptyState.style.display = "none";
                }

                data.forEach(p => {
                    patientsBody.innerHTML += `
                    <tr>
                        <td>${p.nom}</td>
                        <td>${p.prenom}</td>
                        <td>${p.email}</td>
                        <td style="text-align:center;">
                            <a href="/medecin/patient/edit/${p.id}" class="btn btn-warning btn-sm">âœï¸ Modifier</a>
                            <form action="/medecin/patient/supprimer/${p.id}" method="post" style="display:inline;" onsubmit="return confirm('Supprimer ce patient ?');">
                                <button type="submit" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Supprimer</button>
                            </form>
                        </td>
                    </tr>
                `;
                });
            });
    });
</script>
</body>
</html>